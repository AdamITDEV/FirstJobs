@{
    ViewData["Title"] = "Contacts";
    Layout = "~/Views/Shared/Layout/_Layout.cshtml";
}

<div class="content-header">
    <div class="container-fluid">
        <h1 class="m-0 text-dark">Contacts</h1>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <button id="btnCreate" class="btn btn-primary"><i class="fa fa-plus"></i> New</button>
                </div>
                <div class="input-group" style="width:280px">
                    <input id="keyword" class="form-control" placeholder="Search name/phone">
                    <div class="input-group-append">
                        <button id="btnSearch" class="btn btn-outline-secondary"><i class="fa fa-search"></i></button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <table id="tbl" class="table table-striped table-bordered w-100">
                    <thead><tr><th>Name</th><th>Phone</th><th style="width:120px;">Actions</th></tr></thead>
                </table>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="/AbpServiceProxies/GetAll"></script>
    <script src="/AbpScripts/GetScripts"></script>
    <script>
        var svc = abp.services.app.contact;
        var dt;

        function openModal(m){
          $.get('@Url.Action("EditModal", "Contacts")').done(function(html){
            $('#contactEditModal').remove();
            $('body').append(html);
            $('#Id').val(m?.id||'');
            $('#FullName').val(m?.fullName||'');
            $('#PhoneNumber').val(m?.phoneNumber||'');
            $('#contactEditModal').modal({backdrop:'static',keyboard:false}).modal('show');
          }).fail(function(xhr){
            abp.message.error('Load modal failed: '+xhr.status+' '+xhr.statusText);
          });
        }

        function editRow(id){ svc.get({ id:id }).done(openModal); }

        // ✅ Sửa hàm xóa: dùng Promise, có busy + bắt lỗi rõ ràng
        function delRow(id){
          abp.message.confirm('Delete this contact?', 'Confirm').then(function(isConfirmed){
            if(!isConfirmed) return;

            abp.ui.setBusy('#tbl');
            svc.delete({ id:id })
              .done(function(){
                dt.ajax.reload(null,false);
                abp.notify.success('Deleted');
              })
              .fail(function(xhr){
                var msg = (xhr.responseJSON && xhr.responseJSON.error && xhr.responseJSON.error.message) || 'Delete failed';
                abp.message.error(msg);
                console.error('Delete failed', xhr);
              })
              .always(function(){ abp.ui.clearBusy('#tbl'); });
          });
        }

        $(function(){
          dt = $('#tbl').DataTable({
            dom:'lrtip',
            serverSide:true, processing:true, paging:true, searching:false, responsive:true,
            ajax:function(d,cb){
              var req={ maxResultCount:d.length, skipCount:d.start, sorting:'creationTime DESC', keyword:$('#keyword').val()||'' };
              svc.getAll(req).done(function(res){
                cb({ data: res.items, recordsTotal: res.totalCount, recordsFiltered: res.totalCount });
              });
            },
            columns:[
              { data:'fullName' },
              { data:'phoneNumber' },
              { data:null, orderable:false, render:function(r){
                  // ✅ giữ inline onclick cho nhanh gọn
                  return '<button class="btn btn-sm btn-secondary mr-1" onclick="editRow('+r.id+')"><i class="fa fa-edit"></i></button>'
                       + '<button class="btn btn-sm btn-danger" onclick="delRow('+r.id+')"><i class="fa fa-trash"></i></button>';
                }
              }
            ]
          });

          $(document).on('click', '#btnCreate', function(){ openModal(null); });
          $(document).on('click', '#btnSearch', function(){ dt.ajax.reload(); });
        });
    </script>
}
